# Prometheus 1C Exporter

–ú–Ω–æ–≥–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç–µ—Ä –º–µ—Ç—Ä–∏–∫ 1–° –¥–ª—è Prometheus —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–±–æ—Ä–æ–º –¥–∞–Ω–Ω—ã—Ö.

## üîç –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- –°–±–æ—Ä –∫–ª—é—á–µ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫ 1–° —á–µ—Ä–µ–∑ —É—Ç–∏–ª–∏—Ç—É `rac`:
  - –ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –ª–∏—Ü–µ–Ω–∑–∏–∏
  - –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π
  - –ê–∫—Ç–∏–≤–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏ —Å–µ–∞–Ω—Å—ã
  - –†–µ—Å—É—Ä—Å—ã –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (–ø–∞–º—è—Ç—å, CPU)
  - –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏—Å–∫–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (IOPS, latency)
  - –°—Ç–∞—Ç—É—Å —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π
  - –ò –¥—Ä—É–≥–∏–µ [–ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏](#–º–µ—Ç—Ä–∏–∫–∏)

- –ì–∏–±–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–±–æ—Ä–æ–º –º–µ—Ç—Ä–∏–∫:
  - –í—ã–±–æ—Ä–æ—á–Ω–∞—è –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–±–æ—Ä–∞
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
  - –†–∞–∑–¥–µ–ª—å–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –º–µ—Ç—Ä–∏–∫

- –ì–æ—Ç–æ–≤—ã–µ –ø—Ä–∏–º–µ—Ä—ã –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è Grafana
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–±–æ—Ç—ã –≤ –∫–∞—á–µ—Å—Ç–≤–µ —Å–ª—É–∂–±—ã (Windows/Linux)

![–ü—Ä–∏–º–µ—Ä –¥–∞—à–±–æ—Ä–¥–∞](doc/img/browser_d8CBonI15Y.png "–û–±–∑–æ—Ä –º–µ—Ç—Ä–∏–∫")
![–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–æ–≤](doc/img/browser_FCaSoFVBDe.png "–î–æ—Å—Ç—É–ø–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å")

## üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
- Go 1.19+ (–¥–ª—è —Å–±–æ—Ä–∫–∏ –∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤)
- –î–æ—Å—Ç—É–ø –∫ —É—Ç–∏–ª–∏—Ç–µ `rac`
- Prometheus 2.0+

### –°–ø–æ—Å–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∫–∏:
1. **–ì–æ—Ç–æ–≤—ã–µ –±–∏–Ω–∞—Ä–Ω–∏–∫–∏**:  
   [–°–∫–∞—á–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–ª–∏–∑](https://github.com/LazarenkoA/prometheus_1C_exporter/releases)

2. **–°–±–æ—Ä–∫–∞ –∏–∑ –∏—Å—Ö–æ–¥–Ω–∏–∫–æ–≤**:
   ```bash
   git clone https://github.com/LazarenkoA/prometheus_1C_exporter
   cd prometheus_1C_exporter
   go build -o "1C_exporter"
   ```
## üöÄ –ó–∞–ø—É—Å–∫
**Linux:**
```bash
./1C_exporter -port=9095 --settings=/path/to/settings.yaml
```
**Windows:**
```bash
./1C_exporter.exe -port=9095 --settings=/path/to/settings.yaml
```
–ø—Ä–∏–º–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫ [examples_settings.yaml](examples_settings.yaml)


## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Prometheus
–î–æ–±–∞–≤—å—Ç–µ –≤ `prometheus.yml`:
```yaml
scrape_configs:
  - job_name: '1c_metrics'
    scrape_interval: 30s
    metrics_path: '/metrics'
    static_configs:
      - targets: ['1c-server1:9091', '1c-server2:9091']
```    
–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —Ä–∞–∑–¥–µ–ª—å–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –º–µ—Ç—Ä–∏–∫
```yaml
scrape_configs:
  - job_name: '1c_os_metrics'
    scrape_interval: 10s
    metrics_path: '/metrics_os'
    static_configs:
      - targets: ['1c-server1:9091']

  - job_name: '1c_rac_metrics'
    scrape_interval: 30s
    metrics_path: '/metrics_rac'
    static_configs:
      - targets: ['1c-server1:9091']
```    

## üõ† –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–±–æ—Ä–æ–º –º–µ—Ç—Ä–∏–∫
| –ú–µ—Ç–æ–¥ | URL-—Ñ–æ—Ä–º–∞—Ç | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã                         |
|-------|------------|-----------------------------------|
| GET   | /Pause      | metricNames<br/> offsetMin (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) |
| GET   | /Continue   | metricNames                      |

**–ü—Ä–∏–º–µ—Ä—ã:**
–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–±–æ—Ä –Ω–∞ 5 –º–∏–Ω—É—Ç:
```
http://host:9091/Pause?metricNames=processes,connections&offsetMin=5
```

–í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å —Å–±–æ—Ä:
``` 
http://host:9091/Continue?metricNames=disk_metrics
```

## üìä –ú–µ—Ç—Ä–∏–∫–∏
### –û—Å–Ω–æ–≤–Ω—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏

–ö–∞—Ç–µ–≥–æ—Ä–∏—è      | –ú–µ—Ç—Ä–∏–∫–∏                       | –≠–Ω–¥–ø–æ–∏–Ω—Ç
---------------|-------------------------------|-----------------
–°–∏—Å—Ç–µ–º–Ω—ã–µ      | CPU, –ø–∞–º—è—Ç—å, –¥–∏—Å–∫–∏             | `/metrics_os`
RAC-–º–µ—Ç—Ä–∏–∫–∏    | –õ–∏—Ü–µ–Ω–∑–∏–∏, —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è, —Å–µ–∞–Ω—Å—ã   | `/metrics_rac`
–ö–æ–º–ø–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–µ | –í—Å–µ –º–µ—Ç—Ä–∏–∫–∏                    | `/metrics`

### –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫

–ú–µ—Ç—Ä–∏–∫–∞            | –û–ø–∏—Å–∞–Ω–∏–µ                                  | –¢–∏–ø –¥–∞–Ω–Ω—ã—Ö
-------------------|-------------------------------------------|-------------
`available_performance`   |   –î–æ—Å—Ç—É–ø–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ö–æ—Å—Ç–∞       | HistogramVec
`sessions_data`    |   –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Å–µ—Å—Å–∏–π –∏–∑ –∫–ª–∞—Å—Ç–µ—Ä–∞ 1–°     | HistogramVec
`session`  |    –°–µ—Å—Å–∏–∏ 1–°        | HistogramVec
`connect`       |    –°–æ–µ–¥–∏–Ω–µ–Ω–∏—è 1–°         | HistogramVec
`client_lic`     |  –ö–∏–µ–Ω—Ç—Å–∫–∏–µ –ª–∏—Ü–µ–Ω–∑–∏–∏ 1–°            | HistogramVec
`shedule_job`     |  –°–æ—Å—Ç–æ—è–Ω–∏–µ –≥–∞–ª–∫–∏ "–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ä–µ–≥–ª–∞–º–µ–Ω—Ç–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π", –µ—Å–ª–∏ –≥–∞–ª–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∑–Ω–∞—á–µ–Ω–∏–µ –±—É–¥–µ—Ç 1 –∏–Ω–∞—á–µ 0 –∏–ª–∏ –º–µ—Ç—Ä–∏–∫–∞ –±—É–¥–µ—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å            | Gauge
`cpu`     |  –ú–µ—Ç—Ä–∏–∫–∏ CPU –æ–±—â–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä–∞"             | HistogramVec
`processes`     |–ú–µ—Ç—Ä–∏–∫–∏ CPU/–ø–∞–º—è—Ç–∏ –≤ —Ä–∞–∑—Ä–µ–∑–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤              | HistogramVec
`disk`     |   –ü–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –¥–∏—Å–∫–æ–≤            | HistogramVec



## üìà –ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ PromQL
–ö–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –ª–∏—Ü–µ–Ω–∑–∏–∏:
```
sum by (licSRV) (client_lic{quantile="0.99", licSRV=~"(?i).+sys.+"})
```

–°—Ä–µ–¥–Ω—è—è –∑–∞–≥—Ä—É–∑–∫–∞ CPU:
```
avg_over_time(CPU{quantile="0.99"} [1m])
```

–ó–∞–≥—Ä—É–∑–∫–∞ CPU –≤ —Ä–∞–∑—Ä–µ–∑–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:
```
topk(10, sum(avg_over_time(Processes{quantile="0.99", metrics="cpu"}[1m])) by (procName) )
```

–ó–∞–≥—Ä—É–∑–∫–∞ –û–ó–£ –≤ —Ä–∞–∑—Ä–µ–∑–µ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:
```
topk(10, sum(avg_over_time(Processes{quantile="0.99", metrics="memoryRSS"}[1m])) by (procName) )
```

–î–æ—Å—Ç—É–ø–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å 1–°:
```
avg_over_time(AvailablePerformance{quantile="0.99"}[10m])
```

–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ–∞–Ω—Å–æ–≤ –≤ 1–°:
```
Session{quantile="0.99"}
```

## ‚ö†Ô∏è –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –æ—à–∏–±–æ–∫
–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:
- –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å RAC-—É—Ç–∏–ª–∏—Ç—ã
- –ü—Ä–∞–≤–∞ –Ω–∞ —á—Ç–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
- –û—Ç–∫—Ä—ã—Ç—ã–µ –ø–æ—Ä—Ç—ã –≤ firewall
- –õ–æ–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (—Ä–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏ —á–µ—Ä–µ–∑ —É—Å—Ç–∞–Ω–æ–≤–∫—É —É—Ä–æ–≤–Ω—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è `LogLevel: 5` –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ)